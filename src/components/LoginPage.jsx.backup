// LoginPage.jsx - ÂìçÂ∫îÂºèÁâàÊú¨
import React, { useState, useContext } from "react";
import { useNavigate } from "react-router-dom";
import { PlayerContext } from "../context/PlayerContext";
import { updateUserContext } from "../utils/update";
const API_URL = process.env.REACT_APP_API_URL;

function LoginPage() {
  const [playerIdInput, setPlayerIdInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [showLangModal, setShowLangModal] = useState(false);
  const { setPlayerId, setPlayerData } = useContext(PlayerContext);
  const navigate = useNavigate();

  const [tempUserData, setTempUserData] = useState(null);
  const [selectedLang, setSelectedLang] = useState("en");

  // ÁôªÂΩïÂ§ÑÁêÜÂáΩÊï∞
  const handleLogin = async () => {
    if (!playerIdInput.trim()) {
      alert("Please enter your Player ID!");
      return;
    }
    setIsLoading(true);

    try {
      const response = await fetch(`${API_URL}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ playerId: playerIdInput }),
      });

      const data = await response.json();

      if (!response.ok) {
        alert(data.message || "Login failed");
        setIsLoading(false);
        return;
      }

      console.log("Logged in:", data);
      setPlayerId(playerIdInput);
      setPlayerData(data);

      // ÊòæÁ§∫ËØ≠Ë®ÄÈÄâÊã©ÂºπÁ™ó
      setTempUserData(data);
      setShowLangModal(true);
    } catch (error) {
      console.error("Login failed:", error);
      alert("Network error or server not responding");
      setIsLoading(false);
    }
  };

  // Á°ÆËÆ§ËØ≠Ë®ÄÈÄâÊã©
  const confirmLanguage = async () => {
    console.log("üéØ confirmLanguage ÂºÄÂßãÊâßË°å");
    
    try {
      setPlayerData((prev) => ({ ...prev, language: selectedLang }));
      await updateUserContext(playerIdInput, {
        ...tempUserData,
        language: selectedLang,
      });
      console.log("Language updated:", selectedLang);
    } catch (error) {
      console.error("Error updating language:", error);
    }
    
    setShowLangModal(false);
    setIsLoading(false);

    console.log("üéØ ÂáÜÂ§áÊ£ÄÊü•Ë∑≥ËΩ¨ÈÄªËæëÔºåplayerIdInput:", playerIdInput);

    // Ê£ÄÊü•ÊòØÂê¶È¶ñÊ¨°ÁôªÂΩïÔºàÊòØÂê¶Â∑≤ÁúãËøá cutsceneÔºâ
    // È¶ñÊ¨°ÁôªÂΩïÊµÅÁ®ãÔºöLoginPage ‚Üí IntroPage/CutscenePlayer ‚Üí LoadingPage ‚Üí GameScreen
    // ÂÜçÊ¨°ÁôªÂΩïÊµÅÁ®ãÔºöLoginPage ‚Üí LoadingPage ‚Üí GameScreen
    const cutsceneSeenKey = `cutsceneSeen_v1_${playerIdInput}`;
    const cutsceneSeen = localStorage.getItem(cutsceneSeenKey);
    
    console.log("üîç Login flow check:", {
      playerId: playerIdInput,
      cutsceneSeenKey,
      cutsceneSeen,
      isFirstLogin: cutsceneSeen !== "1"
    });

    if (cutsceneSeen === "1") {
      // ÂÜçÊ¨°ÁôªÂΩïÔºöÂ∑≤ÁúãËøá cutsceneÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞Âä†ËΩΩÈ°µ
      console.log("‚úÖ ÂÜçÊ¨°ÁôªÂΩïÔºöË∑≥ËΩ¨Âà∞ LoadingPage");
      navigate("/loading");
      console.log("‚úÖ navigate('/loading') Â∑≤Ë∞ÉÁî®");
    } else {
      // È¶ñÊ¨°ÁôªÂΩïÔºöÊú™ÁúãËøá cutsceneÔºåË∑≥ËΩ¨Âà∞‰ªãÁªçÈ°µ
      console.log("‚úÖ È¶ñÊ¨°ÁôªÂΩïÔºöË∑≥ËΩ¨Âà∞ IntroPage (CutScenePlayer)");
      navigate("/intro");
      console.log("‚úÖ navigate('/intro') Â∑≤Ë∞ÉÁî®");
    }
    
    console.log("üéØ confirmLanguage ÊâßË°åÂÆåÊàê");
  };

  const handleKeyPress = (e) => {
    if (e.key === "Enter") handleLogin();
  };

  return (
    <div style={styles.container}>
      <div style={styles.loginBox}>
        <h1 style={styles.title}>üç≥ FEASTORY</h1>
        <h2 style={styles.subtitle}>Welcome Back!</h2>
        <p style={styles.description}>
          Please enter your Player ID to continue your journey
        </p>

        <div style={styles.inputContainer}>
          <input
            type="text"
            value={playerIdInput}
            onChange={(e) => setPlayerIdInput(e.target.value)}
            onKeyPress={handleKeyPress}
            style={styles.input}
            placeholder="Your Player ID"
            disabled={isLoading}
          />
          <button
            onClick={handleLogin}
            style={{
              ...styles.button,
              opacity: isLoading ? 0.6 : 1,
              cursor: isLoading ? "not-allowed" : "pointer",
            }}
            disabled={isLoading}
          >
            {isLoading ? "Logging in..." : "Login"}
          </button>
        </div>

        <div style={styles.hint}>
          <p>üí° First time? Enter the given player id to start your journey!</p>
        </div>
      </div>

      {/* ËØ≠Ë®ÄÈÄâÊã©ÂºπÁ™ó */}
      {showLangModal && (
        <div style={modalStyles.overlay}>
          <div style={modalStyles.box}>
            <h3 style={{ marginBottom: "16px" }}>
              SELECT LANGUAGE / ÈÄâÊã©ËØ≠Ë®Ä
            </h3>
            <div
              style={{
                display: "flex",
                flexDirection: "column",
                gap: "10px",
              }}
            >
              <button
                style={{
                  ...modalStyles.option,
                  borderColor: selectedLang === "en" ? "#667eea" : "#ccc",
                }}
                onClick={() => setSelectedLang("en")}
              >
                üá∫üá∏ English
              </button>
              <button
                style={{
                  ...modalStyles.option,
                  borderColor: selectedLang === "zh" ? "#667eea" : "#ccc",
                }}
                onClick={() => setSelectedLang("zh")}
              >
                üá®üá≥ ‰∏≠Êñá
              </button>
            </div>
            <button style={modalStyles.confirm} onClick={confirmLanguage}>
              {selectedLang === "zh" ? "Â•ΩÁöÑ" : "Got it!"}
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

const styles = {
  container: {
    minHeight: "100vh",
    width: "100vw",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    background: "#1a1a2e",
  },
  loginBox: {
    background: "#2a2a2a",
    borderRadius: "8px",
    padding: "30px",
    boxShadow: "8px 8px 0px #000",
    textAlign: "center",
    maxWidth: "400px",
    width: "100%",
    border: "4px solid #4a5568",
  },
  title: {
    fontSize: "2rem",
    color: "#ffd700",
  },
  subtitle: {
    fontSize: "1.2rem",
    color: "#e2e8f0",
  },
  description: {
    color: "#94a3b8",
    marginBottom: "20px",
  },
  inputContainer: { display: "flex", flexDirection: "column", gap: "15px" },
  input: {
    padding: "12px",
    fontSize: "1rem",
    border: "2px solid #4a5568",
    background: "#1a1a2e",
    color: "#e2e8f0",
  },
  button: {
    padding: "12px",
    fontSize: "1rem",
    background: "#4a5568",
    color: "#ffd700",
    border: "3px solid #2F1B14",
    cursor: "pointer",
  },
  hint: { marginTop: "15px", color: "#94a3b8" },
};

const modalStyles = {
  overlay: {
    position: "fixed",
    top: 0,
    left: 0,
    width: "100vw",
    height: "100vh",
    background: "rgba(0,0,0,0.8)",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    zIndex: 2000,
  },
  box: {
    background: "white",
    padding: "30px",
    borderRadius: "12px",
    width: "320px",
    textAlign: "center",
  },
  option: {
    padding: "12px",
    border: "2px solid #ccc",
    borderRadius: "8px",
    cursor: "pointer",
    fontSize: "16px",
  },
  confirm: {
    marginTop: "20px",
    padding: "12px",
    background: "#667eea",
    color: "white",
    border: "none",
    borderRadius: "8px",
    cursor: "pointer",
    width: "100%",
    fontSize: "16px",
  },
};

export default LoginPage;
